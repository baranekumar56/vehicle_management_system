<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Appointments — Vehicle Service Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#241358',
          },
        },
      },
    };
  </script>
  <style>
    @keyframes popIn { from { transform: translateY(6px) scale(.995); opacity: 0 } to { transform: translateY(0) scale(1); opacity: 1 } }
    .anim-pop { animation: popIn .12s ease-out both; }
    .modal-wrap { display: none; position: fixed; inset: 0; z-index: 60; align-items: center; justify-content: center; background: rgba(0,0,0,.45); padding: 1rem; }
    .modal-wrap.show { display: flex; }
    @keyframes bounce-in {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    .animate-bounce-in {
      animation: bounce-in 0.25s ease forwards;
    }
  </style>
</head>

<body class="bg-gray-50 text-sm">
  <div id="sidebar-root"></div>
  <div id="navbar-root"></div>

  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex flex-wrap gap-3 items-center justify-between py-3">
        <div class="flex items-center gap-3">
          <h1 class="text-lg font-semibold">Appointments</h1>
          <span class="text-gray-500 hidden sm:inline"> / Vehicle Service Management</span>
        </div>
        <div class="w-full sm:w-auto mt-2 sm:mt-0">
          <div id="filters" class="bg-white border border-gray-200 rounded flex flex-wrap gap-2 p-2 items-center">
            <input id="searchInput" class="border rounded px-3 py-2 min-w-[180px] focus:ring-2 focus:ring-blue-400" placeholder="Search booking / vehicle / service..." />
            <input id="vehicleFilter" class="border rounded px-3 py-2 min-w-[140px]" placeholder="Vehicle no" />
            <input id="dateFrom" type="date" class="border rounded px-3 py-2" />
            <input id="dateTo" type="date" class="border rounded px-3 py-2" />
            <select id="filterStatus" class="border rounded px-3 py-2">
              <option value="">All Status</option>
              <option>Booked</option>
              <option>Ongoing</option>
              <option>Halted</option>
              <option>Pending</option>
              <option>Service Completed</option>
              <option>Repair Completed</option>
              <option>canceled</option>
            </select>
            <select id="filterPayment" class="border rounded px-3 py-2">
              <option value="">All Payment</option>
              <option>booked</option>
              <option>waiting for billing</option>
              <option>bill confirmation</option>
              <option>unpaid</option>
              <option>pending</option>
              <option>completed</option>
              <option>canceled</option>
            </select>
            <select id="filterService" class="border rounded px-3 py-2">
              <option value="">All Types</option>
              <option>Service</option>
              <option>Repair</option>
            </select>
            <button id="applyFiltersBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Apply</button>
            <button id="clearFiltersBtn" class="px-3 py-2 bg-gray-100 rounded">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
    <section id="desktopSection" class="hidden sm:block">
      <div class="overflow-x-auto bg-white border border-gray-200 rounded shadow-sm">
        <table class="min-w-[1000px] w-full table-auto border-collapse">
          <thead class="bg-gray-50 text-gray-700">
            <tr>
              <th class="text-left px-4 py-3 border-b">Booking id</th>
              <th class="text-left px-4 py-3 border-b">Vehicle no</th>
              <th class="text-left px-4 py-3 border-b">Date</th>
              <th class="text-left px-4 py-3 border-b">Time</th>
              <th class="text-left px-4 py-3 border-b">Service Type</th>
              <th class="text-left px-4 py-3 border-b">Status</th>
              <th class="text-left px-4 py-3 border-b">Payment</th>
              <th class="text-left px-4 py-3 border-b">Actions</th>
            </tr>
          </thead>
          <tbody id="desktopTableBody" class="bg-white"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-gray-600" id="desktopPageInfo"></div>
        <div class="flex gap-2">
          <button id="desktopPrev" class="px-3 py-1 border rounded disabled:opacity-50">Previous</button>
          <button id="desktopNext" class="px-3 py-1 border rounded disabled:opacity-50">Next</button>
        </div>
      </div>
    </section>

    <section id="mobileSection" class="sm:hidden">
      <div id="mobileList" class="space-y-3"></div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-gray-600" id="mobilePageInfo"></div>
        <div class="flex gap-2">
          <button id="mobilePrev" class="px-3 py-1 border rounded disabled:opacity-50">Previous</button>
          <button id="mobileNext" class="px-3 py-1 border rounded disabled:opacity-50">Next</button>
        </div>
      </div>
    </section>
  </main>

  <div id="infoModal" class="modal-wrap" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg anim-pop overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h3 class="text-lg font-semibold">Appointment Info</h3>
        <button id="closeInfo" class="text-gray-500 hover:text-black text-xl">&times;</button>
      </div>
      <div class="p-4 space-y-3" id="infoModalContent"></div>
      <div class="p-4 border-t flex justify-end gap-2" id="infoModalFooter"></div>
    </div>
  </div>

  <div id="mobileModal" class="modal-wrap" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md h-[85vh] flex flex-col anim-pop overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h3 class="text-lg font-semibold" id="mobileModalTitle">Details</h3>
        <button id="closeMobile" class="text-gray-500 hover:text-black text-xl">&times;</button>
      </div>
      <div class="p-4 overflow-y-auto flex-1 space-y-3" id="mobileModalContent"></div>
      <div class="p-4 border-t flex gap-2 justify-between">
        <div class="flex items-center gap-3">
          <div id="mobileTotal" class="font-medium text-gray-700">Total: ₹0</div>
        </div>
        <div class="flex gap-2"></div>
      </div>
    </div>
  </div>

  <script>
    // Sample data
    const appointments = [
      {
        bookingId: 48898,
        vehicleNo: "TN 01 AB 1234",
        date: "2025-09-13",
        time: "11:00AM",
        serviceType: "Service",
        status: "Ongoing",
        paymentStatus: "pending",
        services: [
          { id: 1, name: "Oil Change", amount: 1200, required: true, active: true },
          { id: 2, name: "Wheel Alignment", amount: 3000, required: false, active: true },
          { id: 3, name: "Brake Check", amount: 500, required: false, active: true }
        ]
      },
      {
        bookingId: 545688,
        vehicleNo: "TN 01 BC 1234",
        date: "2025-09-19",
        time: "03:00PM",
        serviceType: "Repair",
        status: "Booked",
        paymentStatus: "bill confirmation",
        services: [
          { id: 10, name: "Engine Repair", amount: 12000, required: true, active: true },
          { id: 11, name: "Battery Check", amount: 2000, required: false, active: true }
        ]
      },
      {
        bookingId: 123456,
        vehicleNo: "TN 99 XY 9876",
        date: "2025-09-25",
        time: "09:00AM",
        serviceType: "Service",
        status: "Service Completed",
        paymentStatus: "completed",
        services: [
          { id: 20, name: "General Service", amount: 3500, required: true, active: true }
        ]
      }
    ];

    let filtered = [...appointments];
    let currentDesktopPage = 1;
    const desktopRows = 10;
    let currentMobilePage = 1;
    const mobileRows = 5;

    let focusedAppointment = null;

    function formatDate(iso) { return iso ? iso.split("-").reverse().join("/") : ""; }
    function currency(n) { return "₹" + Number(n).toLocaleString("en-IN"); }
    function safeLower(v) { return (v || "").toString().toLowerCase(); }
    function collectFilterValues() {
      return {
        search: document.getElementById("searchInput").value.trim().toLowerCase(),
        vehicle: document.getElementById("vehicleFilter").value.trim().toLowerCase(),
        dateFrom: document.getElementById("dateFrom").value || "",
        dateTo: document.getElementById("dateTo").value || "",
        status: (document.getElementById("filterStatus").value || "").toLowerCase(),
        payment: (document.getElementById("filterPayment").value || "").toLowerCase(),
        service: (document.getElementById("filterService").value || "").toLowerCase()
      };
    }
    function applyFilters() {
      const f = collectFilterValues();
      filtered = appointments.filter(a => {
        const lower = {
          vehicle: safeLower(a.vehicleNo),
          payment: safeLower(a.paymentStatus),
          status: safeLower(a.status),
          serviceType: safeLower(a.serviceType),
          booking: String(a.bookingId),
          time: safeLower(a.time)
        };
        const matchesSearch = !f.search || (
          lower.booking.includes(f.search) ||
          lower.vehicle.includes(f.search) ||
          lower.status.includes(f.search) ||
          lower.payment.includes(f.search) ||
          lower.time.includes(f.search) ||
          a.services.some(s => safeLower(s.name).includes(f.search))
        );
        const matchesVehicle = !f.vehicle || lower.vehicle.includes(f.vehicle);
        const matchesStatus = !f.status || lower.status === f.status;
        const matchesPayment = !f.payment || lower.payment === f.payment;
        const matchesService = !f.service || lower.serviceType === f.service;
        let matchesDate = true;
        if (f.dateFrom) matchesDate = matchesDate && (a.date >= f.dateFrom);
        if (f.dateTo) matchesDate = matchesDate && (a.date <= f.dateTo);
        return matchesSearch && matchesVehicle && matchesStatus && matchesPayment && matchesService && matchesDate;
      });
      currentDesktopPage = 1;
      currentMobilePage = 1;
      renderDesktop();
      renderMobile();
    }
    function clearFilters() {
      document.getElementById("searchInput").value = "";
      document.getElementById("vehicleFilter").value = "";
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      document.getElementById("filterStatus").value = "";
      document.getElementById("filterPayment").value = "";
      document.getElementById("filterService").value = "";
      applyFilters();
    }
    function renderDesktop() {
      const tbody = document.getElementById("desktopTableBody");
      tbody.innerHTML = "";
      const start = (currentDesktopPage - 1) * desktopRows;
      const page = filtered.slice(start, start + desktopRows);
      page.forEach(a => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        const actions = [];
        actions.push(`<button class="px-2 py-1 rounded bg-gray-600 text-white hover:bg-gray-700" onclick="openInfoModal(${a.bookingId})">View</button>`);
        if (safeLower(a.serviceType) !== "repair") {
          actions.push(`<button class="px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700" onclick="openReschedule(${a.bookingId})">Reschedule</button>`);
        }
        actions.push(`<button class="px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700" onclick="cancelAppointment(${a.bookingId})">Cancel</button>`);
        tr.innerHTML = `
          <td class="px-4 py-3 border-b">${a.bookingId}</td>
          <td class="px-4 py-3 border-b">${a.vehicleNo}</td>
          <td class="px-4 py-3 border-b">${formatDate(a.date)}</td>
          <td class="px-4 py-3 border-b">${a.time}</td>
          <td class="px-4 py-3 border-b">${a.serviceType}</td>
          <td class="px-4 py-3 border-b">${a.status}</td>
          <td class="px-4 py-3 border-b">${a.paymentStatus}</td>
          <td class="px-4 py-3 border-b space-x-1">${actions.join("")}</td>
        `;
        tbody.appendChild(tr);
      });
      const totalPages = Math.max(1, Math.ceil(filtered.length / desktopRows));
      document.getElementById("desktopPageInfo").textContent = `Page ${currentDesktopPage} of ${totalPages} (${filtered.length} results)`;
      document.getElementById("desktopPrev").disabled = currentDesktopPage === 1;
      document.getElementById("desktopNext").disabled = currentDesktopPage === totalPages;
    }
    function renderMobile() {
      const wrap = document.getElementById("mobileList");
      wrap.innerHTML = "";
      const start = (currentMobilePage - 1) * mobileRows;
      const page = filtered.slice(start, start + mobileRows);
      page.forEach(a => {
        const card = document.createElement("div");
        card.className = "bg-white p-3 rounded shadow-sm flex items-start justify-between";
        const left = document.createElement("div");
        left.innerHTML = `<div class="font-medium">#${a.bookingId} — ${a.vehicleNo}</div>
                          <div class="text-gray-500">${formatDate(a.date)} | ${a.time} | ${a.serviceType}</div>
                          <div class="text-gray-500">Status: ${a.status} • Payment: ${a.paymentStatus}</div>`;
        const right = document.createElement("div");
        right.className = "flex flex-col items-end gap-2";
        const viewBtn = document.createElement("button");
        viewBtn.className = "text-blue-600 hover:underline";
        viewBtn.innerHTML = "👁 View";
        viewBtn.onclick = () => openMobileModal(a.bookingId);
        right.appendChild(viewBtn);
        if (safeLower(a.paymentStatus) === "bill confirmation") {
          const badge = document.createElement("div");
          badge.className = "mt-1 px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs";
          badge.textContent = "Bill confirmation";
          right.appendChild(badge);
        }
        card.appendChild(left);
        card.appendChild(right);
        wrap.appendChild(card);
      });
      const totalPages = Math.max(1, Math.ceil(filtered.length / mobileRows));
      document.getElementById("mobilePageInfo").textContent = `Page ${currentMobilePage} of ${totalPages} (${filtered.length})`;
      document.getElementById("mobilePrev").disabled = currentMobilePage === 1;
      document.getElementById("mobileNext").disabled = currentMobilePage === totalPages;
    }
    const infoModalEl = document.getElementById("infoModal");
    const infoContent = document.getElementById("infoModalContent");
    const infoFooter = document.getElementById("infoModalFooter");
    function openInfoModal(bookingId) {
      const a = appointments.find(x => x.bookingId === bookingId);
      if (!a) return;
      focusedAppointment = a;
      infoContent.innerHTML = `
        <div class="grid grid-cols-2 gap-2">
          <div><strong>Booking:</strong> ${a.bookingId}</div>
          <div><strong>Vehicle:</strong> ${a.vehicleNo}</div>
          <div><strong>Date:</strong> ${formatDate(a.date)}</div>
          <div><strong>Time:</strong> ${a.time}</div>
          <div><strong>Service Type:</strong> ${a.serviceType}</div>
          <div><strong>Status:</strong> ${a.status}</div>
          <div><strong>Payment:</strong> ${a.paymentStatus}</div>
        </div>
        <hr class="my-3" />
        <div>
          <h4 class="font-semibold mb-2">Services</h4>
          <div id="infoServicesList" class="space-y-1"></div>
        </div>
      `;
      const listWrap = document.getElementById("infoServicesList");
      listWrap.innerHTML = "";
      a.services.forEach(s => {
        const d = document.createElement("div");
        d.className = "flex justify-between items-center border p-2 rounded";
        d.innerHTML = `<div><span class="${s.active ? 'text-gray-900' : 'text-gray-400 line-through'} font-medium">${s.name}</span> ${s.required ? '<span class="text-red-500 ml-1">*</span>' : ''}</div>
                       <div class="${s.active ? 'text-gray-900' : 'text-gray-400 line-through'}">${currency(s.amount)}</div>`;
        listWrap.appendChild(d);
      });
      infoFooter.innerHTML = "";
      const paymentLower = safeLower(a.paymentStatus);
      if (paymentLower === "bill confirmation") {
        const confirmBtn = document.createElement("button");
        confirmBtn.className = "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700";
        confirmBtn.textContent = "Confirm Booking (set to unpaid)";
        confirmBtn.onclick = () => {
          openDesktopBillConfirmation(a);
        };
        infoFooter.appendChild(confirmBtn);
      } else {
        if ((paymentLower === "unpaid" || paymentLower === "pending")) {
          const payBtn = document.createElement("button");
          payBtn.className = "px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700";
          payBtn.textContent = "Pay";
          payBtn.onclick = () => {
            payAppointment(a.bookingId);
            closeInfoModal();
          };
          infoFooter.appendChild(payBtn);
        }
      }
      showModal(infoModalEl);
    }
    function openDesktopBillConfirmation(a) {
      focusedAppointment = a;
      const listWrap = document.getElementById("infoServicesList");
      listWrap.innerHTML = "";
      const title = document.createElement("div");
      title.className = "text-sm text-gray-600 mb-1";
      title.textContent = "Select/Unselect services to confirm. Required items can't be removed.";
      listWrap.appendChild(title);
      a.services.forEach((s, idx) => {
        const row = document.createElement("div");
        row.className = "flex items-center justify-between border p-2 rounded mb-1";
        const label = document.createElement("div");
        label.innerHTML = `<div class="${s.active ? 'text-gray-900' : 'text-gray-400 line-through'} font-medium">${s.name} ${s.required ? '<span class="text-red-500 ml-1">*</span>' : ''}</div>
                           <div class="text-xs ${s.active ? 'text-gray-600' : 'text-gray-400'}">₹${s.amount}</div>`;
        const toggle = document.createElement("button");
        toggle.className = "px-2 py-1 font-bold rounded hover:bg-gray-100";
        toggle.textContent = s.active ? "-" : "+";
        toggle.onclick = (ev) => {
          ev.stopPropagation();
          if (s.required) return;
          s.active = !s.active;
          openDesktopBillConfirmation(a);
        };
        row.appendChild(label);
        row.appendChild(toggle);
        listWrap.appendChild(row);
      });
      infoFooter.innerHTML = "";
      const confirmBtn = document.createElement("button");
      confirmBtn.className = "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700";
      confirmBtn.textContent = "Confirm Booking (set to unpaid)";
      confirmBtn.onclick = () => {
        a.paymentStatus = "unpaid";
        alert(`Booking #${a.bookingId} confirmed. Payment status set to unpaid.`);
        applyFilters();
        closeInfoModal();
      };
      infoFooter.appendChild(confirmBtn);
    }
    function closeInfoModal() { hideModal(infoModalEl); focusedAppointment = null; }
    document.getElementById("closeInfo").onclick = closeInfoModal;

    const mobileModalEl = document.getElementById("mobileModal");
    const mobileContent = document.getElementById("mobileModalContent");
    const mobileTitle = document.getElementById("mobileModalTitle");
    function openMobileModal(bookingId) {
      const a = appointments.find(x => x.bookingId === bookingId);
      if (!a) return;
      focusedAppointment = a;
      mobileTitle.textContent = `Booking #${a.bookingId}`;
      renderMobileModalContent(a);
      showModal(mobileModalEl);
    }
    function renderMobileModalContent(a) {
      mobileContent.innerHTML = "";
      const infoBox = document.createElement("div");
      infoBox.className = "grid grid-cols-2 gap-2";
      infoBox.innerHTML = `
        <div><strong>Vehicle</strong><div class="text-gray-700">${a.vehicleNo}</div></div>
        <div><strong>Date</strong><div class="text-gray-700">${formatDate(a.date)}</div></div>
        <div><strong>Time</strong><div class="text-gray-700">${a.time}</div></div>
        <div><strong>Type</strong><div class="text-gray-700">${a.serviceType}</div></div>
        <div><strong>Status</strong><div class="text-gray-700">${a.status}</div></div>
        <div><strong>Payment</strong><div class="text-gray-700">${a.paymentStatus}</div></div>
      `;
      mobileContent.appendChild(infoBox);
      const servicesWrap = document.createElement("div");
      servicesWrap.className = "mt-3";
      mobileContent.appendChild(servicesWrap);
      function computeTotal() {
        return a.services.filter(s => s.active).reduce((acc, s) => acc + (s.amount || 0), 0);
      }
      const paymentLower = safeLower(a.paymentStatus);
      const serviceList = document.createElement("div");
      serviceList.className = "space-y-2";
      a.services.forEach((s, idx) => {
        const row = document.createElement("div");
        row.className = "flex items-center justify-between border p-2 rounded";
        row.innerHTML = `<div>
          <div class="${s.active ? 'text-gray-900' : 'text-gray-400 line-through'} font-medium">${s.name} ${s.required ? '<span class="text-red-500 ml-1">*</span>' : ''}</div>
          <div class="text-xs ${s.active ? 'text-gray-600' : 'text-gray-400'}">₹${s.amount}</div>
          </div>`;
        const btn = document.createElement("button");
        btn.className = "px-3 py-1 font-bold rounded hover:bg-gray-100";
        btn.textContent = s.active ? "-" : "+";
        if (s.required) {
          btn.disabled = true;
          btn.classList.add("opacity-40", "cursor-not-allowed");
        } else {
          btn.onclick = () => {
            s.active = !s.active;
            renderMobileModalContent(a);
            showModal(mobileModalEl);
          };
        }
        row.appendChild(btn);
        serviceList.appendChild(row);
      });
      servicesWrap.appendChild(serviceList);
      const totalEl = document.getElementById("mobileTotal");
      if (totalEl) totalEl.textContent = `Total: ${currency(computeTotal())}`;
      const footerRight = mobileModalEl.querySelector('.p-4.border-t > div:last-child');
      footerRight.innerHTML = '';
      if (paymentLower === "bill confirmation") {
        const confirmBtn = document.createElement("button");
        confirmBtn.className = "px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700";
        confirmBtn.textContent = "Confirm Booking";
        confirmBtn.onclick = () => {
          a.paymentStatus = "unpaid";
          alert(`Booking #${a.bookingId} confirmed — paymentStatus set to unpaid`);
          applyFilters();
          hideModal(mobileModalEl);
        };
        footerRight.appendChild(confirmBtn);
      }
      if (safeLower(a.serviceType) !== "repair") {
        const resBtn = document.createElement("button");
        resBtn.className = "px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700";
        resBtn.textContent = "Reschedule";
        resBtn.onclick = () => openReschedule(a.bookingId);
        footerRight.appendChild(resBtn);
      }
      if (paymentLower === "unpaid" || paymentLower === "pending") {
        const payBtn = document.createElement("button");
        payBtn.className = "px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700";
        payBtn.textContent = "Pay";
        payBtn.onclick = () => {
          payAppointment(a.bookingId);
          hideModal(mobileModalEl);
        };
        footerRight.appendChild(payBtn);
      }
      const removeBtn = document.createElement("button");
      removeBtn.className = "px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600";
      removeBtn.textContent = "Cancel Booking";
      removeBtn.onclick = () => {
        if (confirm(`Cancel booking #${a.bookingId}?`)) {
          a.status = "canceled";
          a.paymentStatus = "canceled";
          applyFilters();
          hideModal(mobileModalEl);
        }
      };
      footerRight.appendChild(removeBtn);
      if (totalEl) totalEl.textContent = `Total: ${currency(computeTotal())}`;
    }
    document.getElementById("closeMobile").onclick = () => hideModal(mobileModalEl);
    function openReschedule(bookingId) {
      const a = appointments.find(x => x.bookingId === bookingId);
      if (!a) return;
      if (safeLower(a.serviceType) === "repair") return;
      const newDate = prompt("Enter new date (YYYY-MM-DD):", a.date);
      if (!newDate) return;
      const ts = prompt("Choose time slot (type exactly):\n" + ["08:00AM","09:00AM","10:00AM","11:00AM","01:00PM","02:00PM","03:00PM","04:00PM"].join(", "), a.time);
      if (!ts) return;
      a.date = newDate;
      a.time = ts;
      alert(`Appointment #${a.bookingId} rescheduled to ${formatDate(a.date)} at ${a.time}`);
      applyFilters();
    }
    function payAppointment(bookingId) {
      const a = appointments.find(x => x.bookingId === bookingId);
      if (!a) return;
      if (safeLower(a.paymentStatus) === "waiting for billing") { alert("Cannot pay while waiting for billing"); return; }
      a.paymentStatus = "completed";
      applyFilters();
      alert(`Payment completed for booking #${bookingId}`);
    }
    function cancelAppointment(bookingId) {
      if (!confirm(`Are you sure you want to cancel booking #${bookingId}?`)) return;
      const a = appointments.find(x => x.bookingId === bookingId);
      if (!a) return;
      a.status = "canceled";
      a.paymentStatus = "canceled";
      applyFilters();
    }
    function showModal(el) {
      el.classList.add("show");
      el.setAttribute("aria-hidden", "false");
    }
    function hideModal(el) {
      el.classList.remove("show");
      el.setAttribute("aria-hidden", "true");
      focusedAppointment = null;
    }
    document.querySelectorAll('.modal-wrap').forEach(mwrap => {
      mwrap.addEventListener('click', (e) => {
        if (e.target === mwrap) hideModal(mwrap);
      });
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll('.modal-wrap.show').forEach(m => hideModal(m));
      }
    });
    document.getElementById("desktopPrev").onclick = () => { if(currentDesktopPage>1){currentDesktopPage--;renderDesktop()} };
    document.getElementById("desktopNext").onclick = () => { const tp=Math.ceil(filtered.length/desktopRows)||1; if(currentDesktopPage<tp){currentDesktopPage++;renderDesktop()} };
    document.getElementById("mobilePrev").onclick = () => { if(currentMobilePage>1){currentMobilePage--;renderMobile()} };
    document.getElementById("mobileNext").onclick = () => { const tp=Math.ceil(filtered.length/mobileRows)||1; if(currentMobilePage<tp){currentMobilePage++;renderMobile()} };
    document.getElementById("applyFiltersBtn").onclick = applyFilters;
    document.getElementById("clearFiltersBtn").onclick = clearFilters;
    document.getElementById("searchInput").addEventListener('keydown', (e) => { if(e.key==='Enter') applyFilters(); });
    applyFilters();
    window.openInfoModal=openInfoModal;
    window.openReschedule=openReschedule;
    window.cancelAppointment=cancelAppointment;
    window.payAppointment=payAppointment;
    window.openMobileModal=openMobileModal;
  </script>
</body>
</html>
